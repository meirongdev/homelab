---
# Redpanda Connect â€” ä¿¡æ¯ç®¡é“
# ç®¡é“ 1: æ¥æ”¶ Miniflux Webhook â†’ ä¿å­˜åˆ° KaraKeep
# ç®¡é“ 2: å®šæ—¶è½®è¯¢ KaraKeep tag=telegram â†’ æ¨é€åˆ° Gotify
apiVersion: v1
kind: ConfigMap
metadata:
  name: redpanda-connect-config
  namespace: rss-system
data:
  connect.yaml: |
    http:
      enabled: true
      address: "0.0.0.0:4195"

    input:
      http_server:
        path: /save_entry
        allowed_verbs:
          - POST

    pipeline:
      processors:
        - mapping: |
            root.type = "link"
            root.url = this.entry.url
            root.title = this.entry.title

    output:
      http_client:
        url: "http://karakeep.rss-system.svc:3000/api/v1/bookmarks"
        verb: POST
        headers:
          Authorization: "Bearer ${KARAKEEP_API_KEY}"
          Content-Type: "application/json"
        retries: 3
        retry_period: "5s"

  poll-karakeep.yaml: |
    http:
      enabled: false

    input:
      generate:
        interval: "5m"
        mapping: 'root = {}'

    pipeline:
      processors:
        # è·å–æ‰€æœ‰ä¹¦ç­¾åˆ—è¡¨
        - http:
            url: "http://karakeep.rss-system.svc:3000/api/v1/bookmarks?favourited=false&archived=false&limit=50"
            verb: GET
            headers:
              Authorization: "Bearer ${KARAKEEP_API_KEY}"
              Accept: "application/json"
        # ç­›é€‰å¸¦æœ‰ telegram tag çš„ä¹¦ç­¾
        - mapping: |
            root = this.bookmarks.filter(b -> b.tags.any(t -> t.name == "telegram"))
        # ç©ºæ•°ç»„åˆ™è·³è¿‡
        - mapping: |
            if this.length() == 0 {
              root = deleted()
            }
        # å±•å¼€æ•°ç»„ä¸ºå•ç‹¬æ¶ˆæ¯
        - unarchive:
            format: json_array
        # å†…å­˜å»é‡ï¼šå·²æ¨é€çš„ ID è·³è¿‡
        - cache:
            operator: get
            resource: dedup_cache
            key: '${! this.id}'
        - catch:
          # cache miss = æ–°æ¡ç›®ï¼Œç»§ç»­å¤„ç†
          - mapping: 'root = this'
        - switch:
          - check: 'content() == "seen"'
            processors:
              - mapping: 'root = deleted()'
        # æ ‡è®°ä¸ºå·²æ¨é€
        - cache:
            operator: set
            resource: dedup_cache
            key: '${! this.id}'
            value: "seen"
        # æ„é€  Gotify æ¶ˆæ¯
        - mapping: |
            let title = this.content.title.or(this.title).or("New Bookmark")
            let url = this.content.url.or("")
            root.title = "ğŸ“Œ " + $title
            root.message = $url
            root.priority = 5
            root.extras = {
              "client::display": {
                "contentType": "text/plain"
              }
            }

    output:
      http_client:
        url: "${GOTIFY_URL}/message"
        verb: POST
        headers:
          X-Gotify-Key: "${GOTIFY_TOKEN}"
          Content-Type: "application/json"
        retries: 3
        retry_period: "5s"

    cache_resources:
      - label: dedup_cache
        memory:
          default_ttl: "24h"
          compaction_interval: "1h"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redpanda-connect
  namespace: rss-system
  labels:
    app: redpanda-connect
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redpanda-connect
  template:
    metadata:
      labels:
        app: redpanda-connect
    spec:
      containers:
        # ç®¡é“ 1: Miniflux Webhook â†’ KaraKeep
        - name: webhook-to-karakeep
          image: docker.redpanda.com/redpandadata/connect:latest
          args:
            - run
            - /config/connect.yaml
          ports:
            - containerPort: 4195
              name: http
          env:
            - name: KARAKEEP_API_KEY
              valueFrom:
                secretKeyRef:
                  name: redpanda-connect-secret
                  key: karakeep-api-key
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
          volumeMounts:
            - name: config
              mountPath: /config
          livenessProbe:
            httpGet:
              path: /ready
              port: 4195
            initialDelaySeconds: 10
            periodSeconds: 15
          readinessProbe:
            httpGet:
              path: /ready
              port: 4195
            initialDelaySeconds: 5
            periodSeconds: 10
        # ç®¡é“ 2: KaraKeep è½®è¯¢ â†’ Gotify
        - name: karakeep-to-gotify
          image: docker.redpanda.com/redpandadata/connect:latest
          args:
            - run
            - /config/poll-karakeep.yaml
          env:
            - name: KARAKEEP_API_KEY
              valueFrom:
                secretKeyRef:
                  name: redpanda-connect-secret
                  key: karakeep-api-key
            - name: GOTIFY_URL
              valueFrom:
                secretKeyRef:
                  name: redpanda-connect-secret
                  key: gotify-url
            - name: GOTIFY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: redpanda-connect-secret
                  key: gotify-token
          resources:
            requests:
              cpu: 50m
              memory: 64Mi
            limits:
              memory: 128Mi
          volumeMounts:
            - name: config
              mountPath: /config
      volumes:
        - name: config
          configMap:
            name: redpanda-connect-config
---
apiVersion: v1
kind: Service
metadata:
  name: redpanda-connect
  namespace: rss-system
spec:
  type: ClusterIP
  selector:
    app: redpanda-connect
  ports:
    - port: 4195
      targetPort: 4195
      name: http

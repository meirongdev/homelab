# Prometheus Agent for oracle-k3s
# Minimal kube-prometheus-stack: scrape local targets, remote_write to homelab
# Chart: prometheus-community/kube-prometheus-stack

# Disable components not needed on remote cluster
grafana:
  enabled: false

alertmanager:
  enabled: false

prometheusOperator:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

prometheus:
  prometheusSpec:
    # Remote write to homelab Prometheus via Tailscale
    remoteWrite:
      - url: "http://100.107.254.112:31090/api/v1/write"
        writeRelabelConfigs:
          - sourceLabels: [__name__]
            regex: ".*"
            action: keep

    externalLabels:
      cluster: oracle-k3s

    # No local storage needed â€” agent mode
    retention: 2h
    storageSpec: {}

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

    # Scrape postgres-exporter
    # NOTE: cloudflared + Traefik metrics are now collected via OTel Collector (OTLP push to homelab Prometheus)
    additionalScrapeConfigs:
      - job_name: 'postgres-exporter'
        scrape_interval: 30s
        static_configs:
          - targets:
              - miniflux-db-metrics.rss-system.svc:9187

nodeExporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

kubeStateMetrics:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi

# Disable control plane monitoring (not accessible on K3s)
kubeEtcd:
  enabled: false
kubeScheduler:
  enabled: false
kubeControllerManager:
  enabled: false
kubeProxy:
  enabled: false

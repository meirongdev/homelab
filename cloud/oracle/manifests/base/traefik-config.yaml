# Traefik SSO Middlewares for oracle-k3s services
# Must be created in each namespace where SSO-protected HTTPRoutes live,
# because Traefik Gateway API resolves middlewares relative to the HTTPRoute namespace.
#
# Namespaces with protected routes: personal-services, homepage, rss-system
# (uptime-kuma is intentionally excluded — public status page)
# (it-tools and squoosh are intentionally public — no SSO)
#
# ForwardAuth points to the root (/) of oauth2-proxy (NOT /oauth2/auth).
# When unauthenticated, oauth2-proxy at / returns 302 → GitHub OAuth login page.
# Traefik forwardAuth propagates the 302 + Location header to the browser.
# When authenticated, oauth2-proxy at / returns 202 (static upstream) → request passes through.
#
# HTTPRoutes reference "sso-forwardauth" as a single ExtensionRef.
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: sso-forwardauth
  namespace: personal-services
spec:
  forwardAuth:
    address: http://oauth2-proxy.auth-system.svc.cluster.local:4180/
    trustForwardHeader: true
    authRequestHeaders:
      - Cookie
      - X-Forwarded-Host
      - X-Forwarded-Uri
      - X-Forwarded-Proto
      - X-Real-Ip
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Groups
      - Authorization
      - Set-Cookie
      - Location
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: sso-forwardauth
  namespace: homepage
spec:
  forwardAuth:
    address: http://oauth2-proxy.auth-system.svc.cluster.local:4180/
    trustForwardHeader: true
    authRequestHeaders:
      - Cookie
      - X-Forwarded-Host
      - X-Forwarded-Uri
      - X-Forwarded-Proto
      - X-Real-Ip
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Groups
      - Authorization
      - Set-Cookie
      - Location
---
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: sso-forwardauth
  namespace: rss-system
spec:
  forwardAuth:
    address: http://oauth2-proxy.auth-system.svc.cluster.local:4180/
    trustForwardHeader: true
    authRequestHeaders:
      - Cookie
      - X-Forwarded-Host
      - X-Forwarded-Uri
      - X-Forwarded-Proto
      - X-Real-Ip
    authResponseHeaders:
      - X-Auth-Request-User
      - X-Auth-Request-Email
      - X-Auth-Request-Groups
      - Authorization
      - Set-Cookie
      - Location
---
# HelmChartConfig to enable Gateway API provider in Traefik (managed by K3s)
# Also enables Prometheus metrics with per-hostname router labels for traffic visibility
apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    providers:
      kubernetesGateway:
        enabled: true
    metrics:
      prometheus:
        entryPoint: metrics
        addEntryPointsLabels: true
        addRoutersLabels: true       # per-hostname router labels; scraped by OTel Collector
        addServicesLabels: true
    ports:
      metrics:
        port: 9100
        expose:
          default: false             # internal only; OTel Collector scrapes via ClusterIP
---
# ClusterIP Service for OTel Collector to scrape Traefik metrics
apiVersion: v1
kind: Service
metadata:
  name: traefik-metrics
  namespace: kube-system
  labels:
    app.kubernetes.io/name: traefik
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/name: traefik
  ports:
    - port: 9100
      targetPort: 9100
      name: metrics

- name: Install prerequisites on Oracle K3s node
  hosts: oracle_masters
  become: true
  tasks:
    - name: Install prerequisites
      ansible.builtin.apt:
        name:
          - curl
          - git
          - python3-firewall  # required for ansible.posix.firewalld module
        state: present
        update_cache: true

- name: Configure OS for K3s
  hosts: oracle_masters
  become: true
  tasks:
    # OCI Ubuntu 24.04 uses firewalld (nftables backend) â€” not UFW.
    # OCI Security List handles external ingress at the cloud level;
    # firewalld handles it at the OS level. Both must allow K3s ports.
    - name: Allow K3s API port (6443) in firewalld
      ansible.posix.firewalld:
        port: 6443/tcp
        zone: public
        permanent: true
        state: enabled

    - name: Allow HTTP (80) in firewalld
      ansible.posix.firewalld:
        port: 80/tcp
        zone: public
        permanent: true
        state: enabled

    - name: Allow HTTPS (443) in firewalld
      ansible.posix.firewalld:
        port: 443/tcp
        zone: public
        permanent: true
        state: enabled

    - name: Reload firewalld to apply permanent rules
      ansible.builtin.service:
        name: firewalld
        state: reloaded

    # K3s flannel overlay needs pod/service CIDRs and interfaces trusted
    # in firewalld, otherwise the nftables filter_FORWARD chain will reject
    # pod egress traffic with "admin-prohibited".
    - name: Trust K3s pod CIDR (10.52.0.0/16) in firewalld
      ansible.posix.firewalld:
        source: 10.52.0.0/16
        zone: trusted
        permanent: true
        state: enabled

    - name: Trust K3s service CIDR (10.53.0.0/16) in firewalld
      ansible.posix.firewalld:
        source: 10.53.0.0/16
        zone: trusted
        permanent: true
        state: enabled

    - name: Trust cni0 interface in firewalld
      ansible.posix.firewalld:
        interface: cni0
        zone: trusted
        permanent: true
        state: enabled

    - name: Trust flannel.1 interface in firewalld
      ansible.posix.firewalld:
        interface: flannel.1
        zone: trusted
        permanent: true
        state: enabled

    - name: Reload firewalld after adding trusted sources/interfaces
      ansible.builtin.service:
        name: firewalld
        state: reloaded

    # K3s flannel overlay needs FORWARD chain open for pod/service CIDRs.
    # OCI instances use iptables-legacy alongside nftables; set FORWARD ACCEPT.
    - name: Set FORWARD policy to ACCEPT (required for pod-to-pod routing)
      ansible.builtin.iptables:
        chain: FORWARD
        policy: ACCEPT

    - name: Allow K3s pod CIDR (flannel overlay) in FORWARD
      ansible.builtin.iptables:
        chain: FORWARD
        source: 10.52.0.0/16
        jump: ACCEPT

    - name: Allow K3s service CIDR in FORWARD
      ansible.builtin.iptables:
        chain: FORWARD
        destination: 10.53.0.0/16
        jump: ACCEPT

    - name: Persist iptables rules across reboots
      ansible.builtin.shell: |
        mkdir -p /etc/iptables
        iptables-save > /etc/iptables/rules.v4
      changed_when: true

- name: Write K3s config file
  hosts: oracle_masters
  become: true
  tasks:
    - name: Create K3s config directory
      ansible.builtin.file:
        path: /etc/rancher/k3s
        state: directory
        mode: '0755'

    - name: Write /etc/rancher/k3s/config.yaml
      ansible.builtin.copy:
        dest: /etc/rancher/k3s/config.yaml
        mode: '0644'
        content: |
          write-kubeconfig-mode: "644"
          disable:
            - servicelb
          node-name: oracle-k3s
          tls-san:
            - {{ ansible_host }}
          cluster-cidr: "10.52.0.0/16"
          service-cidr: "10.53.0.0/16"

- name: Install K3s single node
  hosts: oracle_masters
  become: true
  tasks:
    - name: Check if K3s is already installed
      ansible.builtin.stat:
        path: /usr/local/bin/k3s
      register: k3s_binary

    - name: Install K3s (reads flags from /etc/rancher/k3s/config.yaml)
      ansible.builtin.shell: |
        curl -sfL https://get.k3s.io | sh -
      when: not k3s_binary.stat.exists
      changed_when: true

    - name: Wait for K3s to be ready
      ansible.builtin.command: k3s kubectl get nodes
      register: k3s_ready
      until: k3s_ready.rc == 0
      retries: 30
      delay: 10
      changed_when: false

- name: Verify cluster
  hosts: oracle_masters
  become: true
  tasks:
    - name: Display cluster status
      ansible.builtin.command: k3s kubectl get nodes -o wide
      register: cluster_status
      changed_when: false

    - name: Show cluster status
      ansible.builtin.debug:
        msg: "{{ cluster_status.stdout_lines }}"

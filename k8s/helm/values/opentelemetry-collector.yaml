# OTel Collector — DaemonSet 模式，替换 Promtail
# Chart: open-telemetry/opentelemetry-collector
# Image: otel/opentelemetry-collector-contrib (含 filelog, k8sattributes processor)
# Exporter: otlp_http 向 Loki OTLP 端点推送日志（loki exporter 在 contrib 0.145+ 已移除）

mode: daemonset

image:
  repository: otel/opentelemetry-collector-contrib

# Presets 处理：挂载 /var/log/pods、filelog receiver、k8sattributes processor 所需 RBAC 和环境变量
presets:
  logsCollection:
    enabled: true
    includeCollectorLogs: false   # 不采集 collector 自身日志，避免循环
  kubernetesAttributes:
    enabled: true
    extractAllPodLabels: false    # 只提取 app label，避免高基数
    extractAllPodAnnotations: false

# 仅覆盖 pipeline 和 exporter 配置
# presets 已自动注入 filelog receiver 和 k8sattributes processor
config:
  processors:
    resource:
      attributes:
        - key: cluster
          value: homelab
          action: upsert
    batch:
      send_batch_size: 10000
      timeout: 5s

  exporters:
    # 使用 otlp_http exporter 向 Loki OTLP 端点推送日志
    # Loki 从 v2.9+ 支持 OTLP HTTP 协议，端点为 /otlp
    otlp_http:
      endpoint: http://loki-gateway.monitoring.svc.cluster.local/otlp
      tls:
        insecure: true

  service:
    pipelines:
      logs:
        receivers: [filelog]
        processors: [k8sattributes, resource, batch]
        exporters: [otlp_http]

# 资源限制（单节点 homelab）
resources:
  requests:
    cpu: 50m
    memory: 64Mi
  limits:
    cpu: 250m
    memory: 256Mi

# chart 内部资源命名使用的 namespace（实际部署 namespace 由 justfile 的 --namespace 参数控制）
namespaceOverride: monitoring

# OTel Collector — DaemonSet 模式，替换 Promtail
# Chart: open-telemetry/opentelemetry-collector
# Image: otel/opentelemetry-collector-contrib (含 filelog, k8sattributes processor)
# Exporter: otlp_http 向 Loki OTLP 端点推送日志（loki exporter 在 contrib 0.145+ 已移除）
# Metrics: prometheus receiver 抓取 cloudflared + Traefik，通过 otlphttp 推送到 Prometheus

mode: daemonset

image:
  repository: otel/opentelemetry-collector-contrib

# Presets 处理：挂载 /var/log/pods、filelog receiver、k8sattributes processor 所需 RBAC 和环境变量
presets:
  logsCollection:
    enabled: true
    includeCollectorLogs: false   # 不采集 collector 自身日志，避免循环
  kubernetesAttributes:
    enabled: true
    extractAllPodLabels: false    # 只提取 app label，避免高基数
    extractAllPodAnnotations: false

# 仅覆盖 pipeline 和 exporter 配置
# presets 已自动注入 filelog receiver 和 k8sattributes processor
config:
  receivers:
    # cloudflared metrics — ClusterIP within cloudflare namespace
    prometheus/cloudflared:
      config:
        scrape_configs:
          - job_name: 'cloudflared'
            scrape_interval: 30s
            static_configs:
              - targets: ['cloudflared-metrics.cloudflare.svc.cluster.local:2000']
                labels:
                  cluster: homelab
                  tunnel: cloudflared

    # Traefik metrics — per-hostname router labels (addRoutersLabels: true in HelmChartConfig)
    prometheus/traefik:
      config:
        scrape_configs:
          - job_name: 'traefik'
            scrape_interval: 15s
            static_configs:
              - targets: ['traefik-metrics.kube-system.svc.cluster.local:9100']
                labels:
                  cluster: homelab

  processors:
    resource:
      attributes:
        - key: cluster
          value: homelab
          action: upsert
    batch:
      send_batch_size: 10000
      timeout: 5s

  exporters:
    # Logs → Loki via OTLP HTTP
    otlp_http/loki:
      endpoint: http://loki-gateway.monitoring.svc.cluster.local/otlp
      tls:
        insecure: true
    # Metrics → Prometheus OTLP receiver (enableFeatures: otlp-write-receiver)
    otlp_http/prometheus:
      endpoint: http://kube-prometheus-stack-prometheus.monitoring.svc.cluster.local:9090/api/v1/otlp
      tls:
        insecure: true

  service:
    pipelines:
      logs:
        receivers: [filelog]
        processors: [k8sattributes, resource, batch]
        exporters: [otlp_http/loki]
      metrics/cloudflared:
        receivers: [prometheus/cloudflared]
        processors: [resource, batch]
        exporters: [otlp_http/prometheus]
      metrics/traefik:
        receivers: [prometheus/traefik]
        processors: [resource, batch]
        exporters: [otlp_http/prometheus]

# 资源限制（单节点 homelab）
resources:
  requests:
    cpu: 50m
    memory: 128Mi
  limits:
    cpu: 300m
    memory: 256Mi

# chart 内部资源命名使用的 namespace（实际部署 namespace 由 justfile 的 --namespace 参数控制）
namespaceOverride: monitoring

# Gateway API resources for unified ingress
# Gateway + HTTPRoutes for calibre-web and homepage
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: homelab-gateway
  namespace: kube-system
spec:
  gatewayClassName: traefik
  listeners:
    - name: http
      protocol: HTTP
      port: 8000
      allowedRoutes:
        namespaces:
          from: All
---
# ReferenceGrants to allow cross-namespace routing
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-gateway-to-calibre
  namespace: personal-services
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: personal-services
  to:
    - group: ""
      kind: Service
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-gateway-to-homepage
  namespace: homepage
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: homepage
  to:
    - group: ""
      kind: Service
---
# HTTPRoute: book.meirong.dev -> calibre-web
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: calibre-web
  namespace: personal-services
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
  hostnames:
    - "book.meirong.dev"
  rules:
    - backendRefs:
        - name: calibre-web
          port: 8083
---
# HTTPRoute: tool.meirong.dev -> it-tools
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: it-tools
  namespace: personal-services
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
  hostnames:
    - "tool.meirong.dev"
  rules:
    - backendRefs:
        - name: it-tools
          port: 80
---
# HTTPRoute: pdf.meirong.dev -> stirling-pdf
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: stirling-pdf
  namespace: personal-services
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
  hostnames:
    - "pdf.meirong.dev"
  rules:
    - backendRefs:
        - name: stirling-pdf
          port: 8080
---
# HTTPRoute: home.meirong.dev -> homepage
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: homepage
  namespace: homepage
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
      port: 8000
  hostnames:
    - "home.meirong.dev"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: homepage
          port: 3000
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-gateway-to-monitoring
  namespace: monitoring
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: monitoring
  to:
    - group: ""
      kind: Service
---
# HTTPRoute: grafana.meirong.dev -> grafana
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: grafana
  namespace: monitoring
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
      port: 8000
  hostnames:
    - "grafana.meirong.dev"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: kube-prometheus-stack-grafana
          port: 80
---
apiVersion: gateway.networking.k8s.io/v1beta1
kind: ReferenceGrant
metadata:
  name: allow-gateway-to-vault
  namespace: vault
spec:
  from:
    - group: gateway.networking.k8s.io
      kind: HTTPRoute
      namespace: vault
  to:
    - group: ""
      kind: Service
---
# HTTPRoute: vault.meirong.dev -> vault
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: vault
  namespace: vault
spec:
  parentRefs:
    - name: homelab-gateway
      namespace: kube-system
      port: 8000
  hostnames:
    - "vault.meirong.dev"
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: vault
          port: 8200

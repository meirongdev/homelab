---
# ExternalSecret 1: GHCR registry auth
# 创建 docker config JSON secret，供 Image Updater 拉取 GHCR 镜像元数据
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-image-updater-ghcr-auth
  namespace: argocd
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: argocd-image-updater-secret
    creationPolicy: Owner
    template:
      type: kubernetes.io/dockerconfigjson
      data:
        .dockerconfigjson: >-
          {"auths":{"ghcr.io":{"username":"{{ .username }}","password":"{{ .pat }}","auth":"{{ printf "%s:%s" .username .pat | b64enc }}"}}}
  data:
    - secretKey: username
      remoteRef:
        key: secret/homelab/github
        property: username
    - secretKey: pat
      remoteRef:
        key: secret/homelab/github
        property: pat
---
# ExternalSecret 2: Git write-back credentials
# Image Updater 用此 secret 向 GitHub repo 提交镜像 tag 更新
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: argocd-image-updater-git-creds
  namespace: argocd
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: vault-backend
    kind: ClusterSecretStore
  target:
    name: git-creds
    creationPolicy: Owner
  data:
    - secretKey: username
      remoteRef:
        key: secret/homelab/github
        property: username
    - secretKey: password
      remoteRef:
        key: secret/homelab/github
        property: pat

# Reset all k8s nodes to a clean state
cleanup-k8s:
    ansible-playbook playbooks/cleanup-k8s.yaml

# Setup K3s cluster on the k8s nodes
setup-k8s:
    ansible-playbook playbooks/setup-k3s.yaml

# Fetch kubeconfig from master node to local machine
fetch-kubeconfig:
    ansible-playbook playbooks/fetch-kubeconfig.yaml

# Update firewall rules
update-firewall:
    ansible-playbook playbooks/update-firewall.yaml

# Remove k3s-homelab config from local kubeconfig
remove-kubeconfig:
    kubectl config delete-cluster k3s-homelab || true
    kubectl config delete-user k3s-homelab-admin || true
    kubectl config delete-context k3s-homelab || true
    @echo "âœ… Removed k3s-homelab configuration from ~/.kube/config"

# Install public key
config-ssh-key:
    ansible-playbook playbooks/config-ssh-access.yaml

# Install Prometheus Node Exporter on all nodes
install-node-exporter:
    ansible-playbook playbooks/install-node-exporter.yaml

# Install Tailscale daemon and join tailnet as subnet router (advertises 10.42/10.43)
# Usage: just setup-tailscale <authkey>
setup-tailscale authkey:
    ansible-playbook playbooks/setup-tailscale.yaml \
      -e "tailscale_authkey={{ authkey }}" \
      --private-key ~/.ssh/vgio

# Fix DNS fallback on K3s nodes (add 8.8.8.8/1.1.1.1 to systemd-resolved)
# Run after network interruption if image pulls fail (CoreDNS can't resolve external names)
fix-dns:
    ansible-playbook playbooks/fix-dns-fallback.yaml
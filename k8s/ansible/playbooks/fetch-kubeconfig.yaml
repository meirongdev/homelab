- name: Fetch kubeconfig to local machine
  hosts: k8s_masters
  become: true
  tasks:
    - name: Read K3s kubeconfig from master
      ansible.builtin.slurp:
        src: /etc/rancher/k3s/k3s.yaml
      register: kubeconfig_raw

    - name: Parse kubeconfig to extract credentials
      ansible.builtin.set_fact:
        kubeconfig_data: "{{ kubeconfig_raw.content | b64decode | from_yaml }}"
      delegate_to: localhost
      become: false

    - name: Create temporary directory for certificates
      ansible.builtin.tempfile:
        state: directory
        suffix: k8s-certs
      register: temp_cert_dir
      delegate_to: localhost
      become: false

    - name: Write CA certificate to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.clusters[0].cluster['certificate-authority-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/ca.crt"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Write client certificate to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.users[0].user['client-certificate-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/client.crt"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Write client key to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.users[0].user['client-key-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/client.key"
        mode: '0600'
      delegate_to: localhost
      become: false

    - name: Set cluster configuration
      ansible.builtin.shell: |
        kubectl config set-cluster k3s-homelab \
          --server=https://{{ ansible_host }}:6443 \
          --certificate-authority={{ temp_cert_dir.path }}/ca.crt \
          --embed-certs=true
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Set user credentials
      ansible.builtin.shell: |
        kubectl config set-credentials k3s-homelab-admin \
          --client-certificate={{ temp_cert_dir.path }}/client.crt \
          --client-key={{ temp_cert_dir.path }}/client.key \
          --embed-certs=true
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Set context
      ansible.builtin.shell: |
        kubectl config set-context k3s-homelab \
          --cluster=k3s-homelab \
          --user=k3s-homelab-admin
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Use the new context
      ansible.builtin.shell: kubectl config use-context k3s-homelab
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Clean up temporary certificate files
      ansible.builtin.file:
        path: "{{ temp_cert_dir.path }}"
        state: absent
      delegate_to: localhost
      become: false

    - name: Display instructions
      ansible.builtin.debug:
        msg: |
          âœ… Kubeconfig has been configured in ~/.kube/config
          
          Cluster name:  k3s-homelab
          Context name:  k3s-homelab
          User name:     k3s-homelab-admin
          Server:        https://{{ ansible_host }}:6443
          
          Current context has been switched to: k3s-homelab
          
          To verify:
            kubectl get nodes
          
          To switch contexts later:
            kubectl config use-context k3s-homelab
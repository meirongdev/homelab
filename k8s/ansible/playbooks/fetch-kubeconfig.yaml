- name: Fetch kubeconfig to local machine
  hosts: k8s_masters
  become: true
  tasks:
    - name: Get the kubeconfig from master
      ansible.builtin.command: microk8s config
      register: kubeconfig_content
      changed_when: false


    - name: Parse kubeconfig to extract credentials
      ansible.builtin.set_fact:
        kubeconfig_data: "{{ kubeconfig_content.stdout | from_yaml }}"
      delegate_to: localhost
      become: false

    - name: Create temporary directory for certificates
      ansible.builtin.tempfile:
        state: directory
        suffix: k8s-certs
      register: temp_cert_dir
      delegate_to: localhost
      become: false

    - name: Write CA certificate to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.clusters[0].cluster['certificate-authority-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/ca.crt"
      delegate_to: localhost
      become: false

    - name: Write client certificate to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.users[0].user['client-certificate-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/client.crt"
      delegate_to: localhost
      become: false

    - name: Write client key to temporary file
      ansible.builtin.copy:
        content: "{{ kubeconfig_data.users[0].user['client-key-data'] | b64decode }}"
        dest: "{{ temp_cert_dir.path }}/client.key"
      delegate_to: localhost
      become: false

    - name: Set cluster configuration
      ansible.builtin.shell: |
        kubectl config set-cluster microk8s-homelab \
          --server=https://{{ ansible_host }}:16443 \
          --certificate-authority={{ temp_cert_dir.path }}/ca.crt \
          --embed-certs=true
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Set user credentials
      ansible.builtin.shell: |
        kubectl config set-credentials microk8s-homelab-admin \
          --client-certificate={{ temp_cert_dir.path }}/client.crt \
          --client-key={{ temp_cert_dir.path }}/client.key \
          --embed-certs=true
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Set context
      ansible.builtin.shell: |
        kubectl config set-context microk8s-homelab \
          --cluster=microk8s-homelab \
          --user=microk8s-homelab-admin
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Use the new context
      ansible.builtin.shell: kubectl config use-context microk8s-homelab
      delegate_to: localhost
      become: false
      changed_when: true

    - name: Clean up temporary certificate files
      ansible.builtin.file:
        path: "{{ temp_cert_dir.path }}"
        state: absent
      delegate_to: localhost
      become: false

    - name: Display instructions
      ansible.builtin.debug:
        msg: |
          âœ… Kubeconfig has been configured in ~/.kube/config
          
          Cluster name:  microk8s-homelab
          Context name:  microk8s-homelab
          User name:     microk8s-homelab-admin
          Server:        https://{{ ansible_host }}:16443
          
          Current context has been switched to: microk8s-homelab
          
          To verify:
            kubectl get nodes
          
          To switch contexts later:
            kubectl config use-context microk8s-homelab
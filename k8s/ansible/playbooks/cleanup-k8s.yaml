- name: Force reset MicroK8s on all nodes by reinstalling
  hosts: k8s_cluster
  become: true
  tasks:
    - name: Check if microk8s service exists
      ansible.builtin.stat:
        path: /etc/systemd/system/snap.microk8s.daemon-cluster-agent.service
      register: microk8s_service_status

    - name: Stop microk8s service if it exists
      ansible.builtin.systemd:
        name: snap.microk8s.daemon-cluster-agent
        state: stopped
      when: microk8s_service_status.stat.exists

    - name: Completely remove the microk8s snap
      community.general.snap:
        name: microk8s
        state: absent